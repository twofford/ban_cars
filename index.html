<!DOCTYPE html>

<html lang="en">

<head>

    <title>BanCars</title>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="src/data/nyc.json"></script>

    <script src="src/data/crashes.json"></script>

    <style>

        body, h1 {
            position: absolute;
        }

        #infobox {
            position: absolute;
            top: 100px;
        }

        .crash {
            fill: blue;
            stroke: red;
        }

        .crash:hover {
            fill: yellow;
        }


    </style>

</head>

<body>

    <h1>Crashes!</h1>

    <div id='infobox'>
    <p id="date"></p>
    <p id="injuries"></p>
    <p id="deaths"></p>
    <p id="contributing-factors"></p>
    </div>

    <!-- <div id="sliderContainer">
        <input id="slider" type="range" min="0" max="10" step="1"><br>
        <span id="range">2010</span>
    </div> -->
    <div id="map"></div>

    <script>

        const width = 1000;
        const height = 1000;
        let yearInput = null;
        const year = ["2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020"]

        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const projection = d3.geoAlbers()
            .scale(100000)
            .rotate([74, 0])
            .center([0, 40.8])
        
        const path = d3.geoPath()
            .projection(projection);
        
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", function() {
                g.selectAll("path")
                    .attr("transform", d3.event.transform);
            });
        
            svg.call(zoom);
            
      
        g.selectAll("path")
            .data(nycJson.features)
            .enter()
            .append("path")
            .attr("fill", "#EEF5F8")
            .attr("stroke", "#169491")
            .attr("d", path)
            
        g.selectAll("path")
            .data(crashesJson.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("class", "crash")
            .on("mouseover", function(d){

                const crashDate = new Date(d.properties.crash_date)

                const crashDateString = crashDate.toDateString();

                const crashTime = d.properties.crash_time.split(":")
                
                const amPm = crashTime[0] >= 12 ? "AM" : "PM";

                let crashHours = crashTime[0];

                let crashMinutes = crashTime[1];

                crashHours = crashHours % 12;

                crashHours = crashHours ? crashHours : 12;

                const crashTimeString = crashHours + ":" + crashMinutes + " " + amPm;

                let contributingFactors = [];

                if (d.properties.contributing_factor_vehicle_1 && d.properties.contributing_factor_vehicle_1 != "Unspecified") {
                    contributingFactors.push(d.properties.contributing_factor_vehicle_1);
                }

                if (d.properties.contributing_factor_vehicle_2 && d.properties.contributing_factor_vehicle_2 != "Unspecified") {
                    contributingFactors.push(d.properties.contributing_factor_vehicle_2);
                }

                if (d.properties.contributing_factor_vehicle_3 && d.properties.contributing_factor_vehicle_3 != "Unspecified") {
                    contributingFactors.push(d.properties.contributing_factor_vehicle_3);
                }

                if (d.properties.contributing_factor_vehicle_4 && d.properties.contributing_factor_vehicle_4 != "Unspecified") {
                    contributingFactors.push(d.properties.contributing_factor_vehicle_4);
                }

                if (d.properties.contributing_factor_vehicle_5 && d.properties.contributing_factor_vehicle_5 != "Unspecified") {
                    contributingFactors.push(d.properties.contributing_factor_vehicle_5);
                }

                if (contributingFactors.length === 0) {
                    contributingFactors.push("Unspecified")
                }

                d3.select("#date").text(`Date: ${crashDateString}, ${crashTimeString}`);
                d3.select("#injuries").text(`Injuries: ${d.properties.number_of_persons_injured}`)
                d3.select("#deaths").text(`Deaths: ${d.properties.number_of_persons_killed}`);
                d3.select("#contributing-factors").text(`Contributing factors: ${contributingFactors}`);
                d3.select(this).attr("class", "crash hover");
            })
            .on("mouseout", function(d){
                d3.select("#date").text("");
                d3.select("#deaths").text("");
                d3.select(this).attr("class", "crash");
            })
            
                        
        d3.select("#slider").on("input", function() {
            update(+this.value);
        })

        function update(value) {
            document.getElementById("range").innerHTML=year[value];
            yearInput = year[value];
            d3.selectAll(".crash")
                .attr("fill", dateMatch);
        }

        function dateMatch(data, value) {
        }


    </script>

</body>

</html>