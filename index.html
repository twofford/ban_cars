<!DOCTYPE html>

<html lang="en">

<head>

    <title>üöó üôÖ‚Äç‚ôÇÔ∏è</title>

    <link rel="stylesheet" type="text/css" href="src/styles/index.css">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="src/data/nyc.json"></script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script src="src/scripts/api_calls.js"></script>

</head>

<body>

    <div id="spinner">
        <div class="rect1"></div>
        <div class="rect2"></div>
        <div class="rect3"></div>
        <div class="rect4"></div>
        <div class="rect5"></div>
    </div>

    <header>
    <h1>NYC Motor Vehicle Collisions</h1>
    </header>

    <form>
    <input id="crash-date-input" type="date"></input>
    <br>
    <button type="button" onclick="updateCrashes()">Show me the collisions!</button>
    </form>

    <div id="infowindow">
        <p id="time"></p>
        <p id="injuries"></p>
        <p id="deaths"></p>
        <p id="vehicles-involved"></p>
        <p id="contributing-factors"></p>
    </div>

    <div id="map"></div>

    <script>

        //hide spinner by default
        d3.select("#spinner")
            .attr("style", "display: none");
            
        updateCrashes = () => {

           // format user input for API call
           let crashDate = document.getElementById("crash-date-input").value;
           crashDate = new Date(crashDate).toISOString();
           crashDate = crashDate.slice(0, crashDate.length - 1);
           crashDate = `crash_date="${crashDate}"`;
           
           // show spinner when api call begins
           d3.select("#spinner").attr("style", "display: block");

           // api call
           $.ajax({
               url: "https://data.cityofnewyork.us/resource/h9gi-nx95.geojson",
               type: "GET",
               data: {
                   "$$app_token": "GeazDF3xhBoHQv3NWt30dElQb",
                   "$limit": 5000,
                   "$where": `${crashDate}`
               }
           }).done(res => {

                //hide spinner when api call ends
                d3.select("#spinner").attr("style", "display: none");

                //create window for tooltips
                const infoWindow = d3.select("#infowindow").style("opacity", 0);

                //bind crash data
                g.selectAll("path.crash")
                    .remove("path")
                    .data(res.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("class", "crash")
                    .on("mouseover", function (d) {
                       
                       //format crash time
                       const crashTime = d.properties.crash_time.split(":")
                       const amPm = crashTime[0] >= 12 ? "AM" : "PM";
                       let crashHours = crashTime[0];
                       let crashMinutes = crashTime[1];
                       crashHours = crashHours % 12;
                       crashHours = crashHours ? crashHours : 12;
                       const crashTimeString = crashHours + ":" + crashMinutes + " " + amPm;
                       
                       //format contributing factors
                       let contributingFactors = [];
                       if (d.properties.contributing_factor_vehicle_1 && d.properties.contributing_factor_vehicle_1 != "Unspecified") {
                           contributingFactors.push(d.properties.contributing_factor_vehicle_1);
                        }
                        if (d.properties.contributing_factor_vehicle_2 && d.properties.contributing_factor_vehicle_2 != "Unspecified") {
                            contributingFactors.push(d.properties.contributing_factor_vehicle_2);
                        }
                        if (d.properties.contributing_factor_vehicle_3 && d.properties.contributing_factor_vehicle_3 != "Unspecified") {
                            contributingFactors.push(d.properties.contributing_factor_vehicle_3);
                        }
                        if (d.properties.contributing_factor_vehicle_4 && d.properties.contributing_factor_vehicle_4 != "Unspecified") {
                            contributingFactors.push(d.properties.contributing_factor_vehicle_4);
                        }
                        if (d.properties.contributing_factor_vehicle_5 && d.properties.contributing_factor_vehicle_5 != "Unspecified") {
                            contributingFactors.push(d.properties.contributing_factor_vehicle_5);
                        }
                        if (contributingFactors.length === 0) {
                            contributingFactors.push("Unspecified")
                        }
                        let uniqueFactors = [...new Set(contributingFactors)];
                        uniqueFactors = uniqueFactors.join(", ");
                        
                        //format vehicles involved
                        let vehiclesInvolved = 0;
                        if (d.properties.contributing_factor_vehicle_1) {
                            vehiclesInvolved += 1;
                        }
                        if (d.properties.contributing_factor_vehicle_2) {
                            vehiclesInvolved += 1;
                        }
                        if (d.properties.contributing_factor_vehicle_3) {
                            vehiclesInvolved += 1;
                        }
                        if (d.properties.contributing_factor_vehicle_4) {
                            vehiclesInvolved += 1;
                        }
                        if (d.properties.contributing_factor_vehicle_5) {
                            vehiclesInvolved += 1;
                        }
                        
                        //show infowindow
                        infoWindow.transition()
                            .duration(200)
                            .style("opacity", 1)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                        
                        //display crash data
                        d3.select("#time").html(`Time: ${crashTimeString}</i>`)
                        d3.select("#injuries").html(`Injuries: ${d.properties.number_of_persons_injured}</i>`)
                        d3.select("#deaths").html(`Deaths: ${d.properties.number_of_persons_killed}</i>`);
                        d3.select("#vehicles-involved").text(`Vehicles Involved: ${vehiclesInvolved}`);
                        d3.select("#contributing-factors").text(`Contributing Factors: ${uniqueFactors}`);
                        d3.select(this).attr("class", "crash hover");
                    })

                    .on("mouseout", function (d) {

                        //hide infowindow
                        infoWindow.transition()
                            .duration(200)
                            .style("opacity", 0);
                    })
            })
        }

        const width = 750;
        const height = 750;

        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const projection = d3.geoAlbers()
            .scale(100000)
            .rotate([73.9, 0])
            .center([0, 40.775])
        
        const path = d3.geoPath()
            .projection(projection);

        g.selectAll("path")
            .data(nyc.features)
            .enter()
            .append("path")
            .attr("fill", "white")
            .attr("stroke", "black")
            .attr("d", path)

    </script>

</body>

</html>